#!/usr/bin/env siesta
# vim: set ft=jinja


#
# Load config
#
{% set conf = loadini("~/.slopify.ini") %}
#
# Import jira
#
{% set jiralib = import("jira") %}
{% set jira=jiralib.JIRA(server=conf.jira.url, basic_auth=(conf.jira.user, conf.jira.api_token)) %})) }

#
# Check the first argument is a ticket
#
{% set ticket_id=input.split()[0] %}
{% if not ticket_id %}
  {{ error("You must specify a ticket number") }}
{% endif %}
{{ print("Ticket:", ticket_id) }}

#
# Load the ticket
#
{% set ticket=jira.issue(ticket_id) %}

#
# Map ticket labels to Github repo
#
{% set ns = namespace(repo=None) %}
{% for label in ticket.fields.labels %}
  {% set ns.repo = conf.jira_labels.get(label) %}
  {% if ns.repo %}{% break %}{% endif %}
{% endfor %}
{% if not ns.repo %}
  {{ error("Could not find a repo for this ticket, labels: {}".format(ticket.fields.labels)) }}
{% endif %}
{% set repo = ns.repo %}
{{print("Repo:", repo)}}


#
# Make a fresh project clone
#
{% set repo_path|run %}
  mktemp -d /tmp/slopify-{{ticket.fields.summary|slugify|escape}}-XXXXXXXX
{% endset %}
{{ cd(repo_path) }}
{{print("Cloning repo to {} ...".format(repo_path))}}
{% filter run() %}
  set -x
  git clone --depth=1 git@github.com:{{repo|escape}} .
{% endfilter %}

#
# Create a fresh branch
#
{{print("Creating fresh branch...")}}
{% set branch|run %}
  branch_candiate={{ticket.key|escape}}-{{ticket.fields.summary|slugify|escape}}
  if git ls-remote --heads origin "$branch_candiate" | grep -q "$branch_candiate"; then
    echo "$branch_candiate"-"$RANDOM"
  else
    echo "$branch_candiate"
  fi
{% endset %}
{% filter run() %}
  set -x
  git checkout -b {{branch|escape}}
{% endfilter %}

#
# implement
#
{% set requested_changes|dedent %}
  ## {{ ticket.fields.summary }}
  {{ ticket.fields.description }}
{% endset %}
{% with input=requested_changes %}
  {% include "util:implement" %}
{% endwith %}

#
# Commit the changes
#
{% include "util:stage-all" %}
{% include "util:commit" %}

#
# Commit any eventual changes done by the hook
#
{% set hook_script = conf.hooks[repo] %}
{% if hook_script %}
  {{print("Running hook script...")}}
  {% filter run %}
    set -ex
    {{ hook_script }}
    git add .
    git diff
    git commit \
      -m {{ conf.hooks_commit[repo]|default("Run hook")|escape }} \
      -m "Co-authored-by: slopify AI <slopify@codegaia.io>" \
      --no-verify || true
  {% endfilter %}
{% else %}
  {{print("No hook script found.")}}
{% endif %}


#
# Push
#
{% filter run %}
    git push --set-upstream origin {{branch|escape}} --no-verify
{% endfilter %}

#
# Prompt for PR title
#
{% include "util:create-pr" %}
