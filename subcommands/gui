#!/usr/bin/env -S uv run --script

# /// script
# dependencies = [
#    "gradio",
#    "pywebview",
# ]
# ///

import gradio as gr
import subprocess
import os
import webview
from functools import partial


def run_slopify(subcommand, user_input):
    process = subprocess.Popen(
        [
            os.path.join(os.path.dirname(__file__), "..", "bin", "slopify"),
            subcommand,
            user_input,
        ],  # or any command/script
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT,
        text=True,
        bufsize=1,
        env=dict(os.environ, PYTHONUNBUFFERED="1"),
    )

    lines = ""
    for line in process.stdout:
        print(line, end="")
        lines += line
        yield lines


with gr.Blocks(
    title="Slopify GUI",
    css="footer {display: none !important;}",  # Hides the Gradio footer
) as demo:


    with gr.Tab("Refine Ticket"):
        gr.Interface(
            fn=partial(run_slopify, "ticket-feedback"),
            inputs=gr.Textbox(
                label="Ticket ID (e.g., ABC-123)",
                placeholder="Enter your ticket ID here",
            ),
            outputs=gr.Textbox(
                label="Log", lines=18, show_copy_button=True, interactive=False
            ),
            flagging_mode="never",
            submit_btn="Get Feedback",
        )

    with gr.Tab("Implement Ticket"):
        gr.Interface(
            fn=partial(run_slopify, "pick-ticket"),
            inputs=gr.Textbox(
                label="Ticket ID (e.g., ABC-123)",
                placeholder="Enter your ticket ID here",
            ),
            outputs=gr.Textbox(
                label="Log", lines=18, show_copy_button=True, interactive=False
            ),
            flagging_mode="never",
            submit_btn="Create Pull Request",
        )

    with gr.Tab("Fix CI"):
        gr.Markdown("TODO: Integrate `slopify fix-ci-simple`.")

    with gr.Tab("Apply Feedback"):
        gr.Markdown("TODO: Integrate `slopify pick-comment`.")

    with gr.Tab("Config"):
        gr.Markdown("TODO: Implement.")


demo.launch(
    server_name="127.0.0.1", server_port=7868, inbrowser=False, prevent_thread_lock=True
)

webview.create_window("Slopify GUI", "http://127.0.0.1:7868")
webview.start()
